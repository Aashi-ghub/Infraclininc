service: borelog-parser
frameworkVersion: '3'

provider:
  name: aws
  runtime: python3.10
  region: ${opt:region, 'us-east-1'}
  stage: ${opt:stage, 'dev'}
  timeout: 30
  memorySize: 512
  environment:
    S3_BUCKET_NAME: ${env:S3_BUCKET_NAME}
    LOG_LEVEL: ${env:BORELOG_PARSER_LOG_LEVEL, 'INFO'}
  iam:
    role:
      statements:
        - Effect: Allow
          Action:
            - s3:GetObject
            - s3:PutObject
            - s3:HeadObject
          Resource:
            - arn:aws:s3:::${env:S3_BUCKET_NAME}
            - arn:aws:s3:::${env:S3_BUCKET_NAME}/*
        - Effect: Allow
          Action:
            - sqs:ReceiveMessage
            - sqs:DeleteMessage
            - sqs:GetQueueAttributes
          Resource:
            - arn:aws:sqs:${self:provider.region}:*:borelog-parser-queue-${self:provider.stage}
            - arn:aws:sqs:${self:provider.region}:*:borelog-parser-dlq-${self:provider.stage}

package:
  patterns:
    - ../borelog_parser/*.py
    - '!**/__pycache__/**'
    - '!**/*.pyc'
    - '!**/*.md'
    - '!**/test_*.py'
    - '!**/example_*.py'
    - '!**/build/**'
    - '!**/*.json'
  excludeDevDependencies: true

functions:
  borelog-parser:
    handler: borelog_parser/lambda_handler.handler
    events:
      - sqs:
          arn: arn:aws:sqs:${self:provider.region}:211946440260:borelog-parser-queue-${self:provider.stage}
          batchSize: 1

